# **************************************************************************** #
#                                miniRT Makefile                               #
# **************************************************************************** #

NAME = miniRT

# è·¯å¾„é…ç½®
SRC_DIR = srcs/
OBJ_DIR = obj/
INC = includes/

LIBFT = ./libft/libft.a
MLX = ./mlx/libmlx.a

# ç¼–è¯‘å™¨ä¸å‚æ•°
CC = gcc
#CFLAGS = -Wall -Wextra -Werror -I$(INC)
#MLX_FLAGS = -Lmlx -lmlx -framework OpenGL -framework AppKit
# å¦‚æœä½ åœ¨Linuxä¸Šç¼–è¯‘ï¼Œåˆ™å–æ¶ˆä¸‹é¢ä¸€è¡Œæ³¨é‡Šå¹¶æ³¨é‡Šæ‰ä¸Šé¢ä¸€è¡Œ
#MLX_FLAGS = -Lmlx -lmlx -lX11 -lXext -lm

# ç¼–è¯‘å™¨ä¸å‚æ•°ï¼ˆè‡ªåŠ¨æ£€æµ‹å¹³å°ï¼›å¯ç”¨ make TARGET_OS=Linux æˆ– TARGET_OS=Darwin è¦†ç›–ï¼‰
CFLAGS  = -Wall -Wextra -Werror -I$(INC)

# å¹³å°æ£€æµ‹ï¼šé»˜è®¤å– uname -sï¼›å…è®¸ç”¨ TARGET_OS æ‰‹åŠ¨è¦†ç›–ï¼ˆDarwin æˆ– Linuxï¼‰
TARGET_OS ?= $(shell uname -s)

ifeq ($(TARGET_OS),Darwin)
    # macOS ä½¿ç”¨ Cocoa ç‰ˆ MiniLibX
    MLX_FLAGS = -Lmlx -lmlx -framework OpenGL -framework AppKit
    CFLAGS   += -DMRT_MACOS
else ifeq ($(TARGET_OS),Linux)
    # Linux ä½¿ç”¨ X11 ç‰ˆ MiniLibX
    MLX_FLAGS = -Lmlx -lmlx -lX11 -lXext -lm
    CFLAGS   += -DMRT_LINUX
else
    $(error Unsupported OS: $(TARGET_OS). Use TARGET_OS=Darwin or TARGET_OS=Linux)
endif

# æºæ–‡ä»¶
SRC_FILES = \
	main.c \
	free/exit_free.c \
	exit/close_window.c \
	math/vec3.c \
	math/vec3_bis.c \
	render/render_scene.c \
	render/ray.c \
	render/ray_hit.c \
	render/ray_utils.c \
	render/ambient.c \
	render/lighting.c \
	render/diffuse.c \
	render/ray_hit_pl.c\
	render/ray_hit_sp.c\
	render/ray_hit_cy.c\
	render/ray_hit_cy_annex.c\
	utils/utils.c \
	utils/utils_2.c\
	utils/error.c \
	utils/img_utils.c \
	init/hook.c \
	init/read_file.c \
	init/parse_utils.c\
	init/parse_scene/parse_amb.c\
	init/parse_scene/parse_cam.c\
	init/parse_scene/parse_light.c\
	init/parse_obj/parse_plane.c\
	init/parse_obj/parse_sphere.c\
	init/parse_obj/parse_cylinder.c

SRCS = $(addprefix $(SRC_DIR), $(SRC_FILES))
OBJS = $(patsubst $(SRC_DIR)%.c,$(OBJ_DIR)%.o,$(SRCS))

# ç¼–è¯‘ç›®æ ‡
all: $(NAME)

$(LIBFT):
	@make -C libft

$(MLX):
	@make -C mlx

$(NAME): $(LIBFT) $(MLX) $(OBJS)
	@$(CC) $(CFLAGS) $(OBJS) $(LIBFT) $(MLX_FLAGS) -o $(NAME)
	@echo "âœ… Build complete: $(NAME)"

$(OBJ_DIR)%.o: $(SRC_DIR)%.c
	@mkdir -p $(@D)
	@echo "[Compile] $< âœ $@"
	@$(CC) $(CFLAGS) -c $< -o $@

# é¢œè‰²å’Œç¬¦å·
GREEN  = \033[1;32m
YELLOW = \033[1;33m
BLUE   = \033[1;34m
RESET  = \033[0m
CHECK  = âœ…
CLEAN  = ğŸ§¹

clean:
	@echo "ğŸ§¹ [clean] Removing miniRT object files..."
	@rm -rf $(OBJ_DIR)
	@echo "ğŸ§¹ [clean] Cleaning libft..."
	-@$(MAKE) -C libft clean > /dev/null || echo "libft clean skipped"
	@echo "ğŸ§¹ [clean] Cleaning mlx..."
	@if [ -f mlx/Makefile ]; then \
		$(MAKE) -C mlx clean > /dev/null || echo "mlx clean failed"; \
	else \
		echo "mlx Makefile not found. Skipping mlx clean."; \
	fi

fclean: clean
	@echo "ğŸ§¹ [fclean] Removing executable $(NAME)..."
	@rm -f $(NAME)
	@echo "ğŸ§¹ [fclean] Running libft fclean..."
	-@$(MAKE) -C libft fclean > /dev/null || echo "libft fclean skipped"
	@echo "ğŸ§¹ [fclean] Running mlx fclean..."
	@if [ -f mlx/Makefile ]; then \
		$(MAKE) -C mlx fclean > /dev/null || echo "mlx fclean failed"; \
	else \
		echo "mlx Makefile not found. Skipping mlx fclean."; \
	fi

re: fclean all
.PHONY: all clean fclean re
